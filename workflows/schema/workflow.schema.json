{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://evolving.local/schemas/workflow.schema.json",
  "title": "Workflow Definition",
  "description": "Schema für Workflow Automation Engine YAML-Definitionen",
  "type": "object",
  "required": ["name", "steps"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Eindeutiger Workflow-Name",
      "pattern": "^[a-z][a-z0-9-]*$"
    },
    "description": {
      "type": "string",
      "description": "Beschreibung des Workflows"
    },
    "version": {
      "type": "string",
      "default": "1.0",
      "pattern": "^\\d+\\.\\d+(\\.\\d+)?$"
    },
    "trigger": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["manual", "cron", "watch", "event"]
        },
        "cron": {
          "type": "string",
          "description": "Cron-Expression (z.B. '0 9 * * 1' für Mo 9:00)"
        },
        "watch": {
          "type": "string",
          "description": "Glob-Pattern für File-Watching (z.B. '_inbox/*')"
        },
        "event": {
          "type": "string",
          "description": "Event-Name (z.B. 'idea.created')"
        }
      },
      "required": ["type"]
    },
    "permissions_profile": {
      "type": "string",
      "default": "default",
      "description": "Name des Permission-Profils"
    },
    "preferences_profile": {
      "type": "string",
      "default": "default",
      "description": "Name des User-Preference-Profils"
    },
    "variables": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name"],
        "properties": {
          "name": {
            "type": "string",
            "pattern": "^[a-z_][a-z0-9_]*$"
          },
          "type": {
            "type": "string",
            "enum": ["string", "number", "boolean", "list"],
            "default": "string"
          },
          "default": {},
          "prompt": {
            "type": "string",
            "description": "Frage an User bei Start"
          },
          "required": {
            "type": "boolean",
            "default": false
          }
        }
      }
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/step"
      }
    },
    "on_error": {
      "type": "string",
      "enum": ["abort", "pause", "continue"],
      "default": "abort"
    },
    "max_steps": {
      "type": "integer",
      "default": 50,
      "minimum": 1,
      "maximum": 500
    },
    "timeout": {
      "type": "string",
      "default": "30m",
      "pattern": "^\\d+[smh]$"
    },
    "dry_run": {
      "type": "boolean",
      "default": false
    },
    "budget": {
      "type": "object",
      "properties": {
        "max_tokens": {
          "type": "integer",
          "minimum": 1000
        },
        "max_cost": {
          "type": "number",
          "minimum": 0.01,
          "description": "Maximale Kosten in USD"
        }
      }
    },
    "audit": {
      "type": "object",
      "properties": {
        "log_level": {
          "type": "string",
          "enum": ["minimal", "standard", "verbose"],
          "default": "standard"
        },
        "include_prompts": {
          "type": "boolean",
          "default": false
        },
        "include_outputs": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "notify": {
      "type": "object",
      "properties": {
        "on_complete": {
          "type": "boolean",
          "default": false
        },
        "on_error": {
          "type": "boolean",
          "default": true
        },
        "method": {
          "type": "string",
          "enum": ["log", "file", "webhook"],
          "default": "log"
        }
      }
    }
  },
  "definitions": {
    "step": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Step-Name"
        },
        "description": {
          "type": "string"
        },
        "command": {
          "type": "string",
          "description": "Claude Code Command (z.B. /idea-list)"
        },
        "prompt": {
          "type": "string",
          "description": "AI Prompt für diesen Step"
        },
        "bash": {
          "type": "string",
          "description": "Shell-Befehl"
        },
        "agent": {
          "type": "string",
          "description": "Agent-Name (z.B. idea-validator-agent)"
        },
        "framework": {
          "type": "string",
          "description": "Framework-Name (z.B. idea-forge)"
        },
        "script": {
          "type": "string",
          "description": "Python-Script-Pfad"
        },
        "mode": {
          "type": "string",
          "description": "Framework-Modus (z.B. divergence, convergence)"
        },
        "config": {
          "type": "object",
          "description": "Framework-Konfiguration"
        },
        "condition": {
          "type": "string",
          "description": "Bedingung für Ausführung (z.B. '{{count}} > 0')"
        },
        "loop": {
          "type": "string",
          "description": "Liste für Iteration (z.B. '{{items}}')"
        },
        "loop_as": {
          "type": "string",
          "description": "Variablenname für Loop-Item"
        },
        "parallel": {
          "type": "boolean",
          "default": false,
          "description": "Sub-Steps parallel ausführen"
        },
        "depends_on": {
          "type": "string",
          "description": "Warten auf anderen Step"
        },
        "branch": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["condition", "steps"],
            "properties": {
              "condition": {
                "type": "string"
              },
              "steps": {
                "type": "array",
                "items": {
                  "$ref": "#/definitions/step"
                }
              }
            }
          }
        },
        "store_as": {
          "type": "string",
          "description": "Variablenname für Result"
        },
        "output": {
          "type": "string",
          "description": "Output-Dateipfad"
        },
        "template": {
          "type": "string",
          "description": "Template für Output"
        },
        "confidence_gate": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Minimum Confidence Score (0-100)"
        },
        "on_low_confidence": {
          "type": "string",
          "enum": ["retry", "abort", "manual_review"],
          "default": "manual_review"
        },
        "model": {
          "type": "string",
          "enum": ["auto", "haiku", "sonnet", "opus"],
          "default": "auto"
        },
        "complexity": {
          "type": "string",
          "enum": ["low", "medium", "high"]
        },
        "on_error": {
          "type": "string",
          "enum": ["abort", "skip", "retry", "pause"],
          "default": "abort"
        },
        "retry_count": {
          "type": "integer",
          "minimum": 0,
          "maximum": 5,
          "default": 0
        },
        "retry_delay": {
          "type": "string",
          "pattern": "^\\d+[smh]$"
        },
        "timeout": {
          "type": "string",
          "pattern": "^\\d+[smh]$"
        }
      },
      "oneOf": [
        { "required": ["command"] },
        { "required": ["prompt"] },
        { "required": ["bash"] },
        { "required": ["agent"] },
        { "required": ["framework"] },
        { "required": ["script"] },
        { "required": ["branch"] }
      ]
    }
  }
}
